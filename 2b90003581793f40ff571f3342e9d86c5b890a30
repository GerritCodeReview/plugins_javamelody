{
  "comments": [
    {
      "key": {
        "uuid": "29647652_962cc716",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "Mention that basic auth doesn\u0027t work atm and that a bearer token auth is the only supported, known to work way for Prometheus scrapping of javameldoy metrics.\n\nThat still raises the question, why basic auth doesn\u0027t actually work for javamelody integration, but (hopefully) works as claimed in metrics-reporter-prometheus plugin with basic auth, using?\n\n  GET http://gerrit.mycompany.com/a/plugins/metrics-reporter-prometheus/metrics\n\nAs discussed in another change that got abandoned, do you think, that patching Javamelody core (yes, I hate to patch third party libraries), like this would solve all our problems: [1]?\n\nOld:\n\n  if (httpRequest.getRequestURI().equals(getMonitoringUrl(httpRequest))) {\n  [...]\n\nNew:\n\n  if (httpRequest.getRequestURI().endsWith(getMonitoringUrl(httpRequest))) {\n  [...]\n\nIn other words, I am fine with that change and with going with Prometheus bearer token authentication only for now, but I would prefer to explain that preference in the commit message and also state that basic auth doesn\u0027t work yet.\n\n[1] https://github.com/javamelody/javamelody/blob/master/javamelody-core/src/main/java/net/bull/javamelody/MonitoringFilter.java#L205",
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8433725b_11661ef3",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-08-11T06:20:52Z",
      "side": 1,
      "message": "\u003e Mention that basic auth doesn\u0027t work atm and that a bearer token auth is the only supported, known to work way for Prometheus scrapping of javameldoy metrics.\n\nSure.\n\n\u003e That still raises the question, why basic auth doesn\u0027t actually work for javamelody integration, but (hopefully) works as claimed in metrics-reporter-prometheus plugin with basic auth, using?\n\u003e \n\u003e   GET http://gerrit.mycompany.com/a/plugins/metrics-reporter-prometheus/metrics\n\nThe metrics-reporter for Prometheus is a Servlet and not a Filter. That\u0027s the reason why it can use Gerrit auth whilst the JavaMelody filter can\u0027t.\n\nAt the end of the day, the JavaMelody filter needs to track *every request* even the ones failing for authentication denied.\n\n\u003e As discussed in another change that got abandoned, do you think, that patching Javamelody core (yes, I hate to patch third party libraries), like this would solve all our problems: [1]?\n\u003e \n\u003e Old:\n\u003e \n\u003e   if (httpRequest.getRequestURI().equals(getMonitoringUrl(httpRequest))) {\n\u003e   [...]\n\u003e \n\u003e New:\n\u003e \n\u003e   if (httpRequest.getRequestURI().endsWith(getMonitoringUrl(httpRequest))) {\n\u003e   [...]\n\nNope, that would never work because we cannot condition the execution of the JavaMelody filter to the ProjectBasicAuth filter.\n\n\u003e In other words, I am fine with that change and with going with Prometheus bearer token authentication only for now, but I would prefer to explain that preference in the commit message and also state that basic auth doesn\u0027t work yet.\n\u003e \n\u003e [1] https://github.com/javamelody/javamelody/blob/master/javamelody-core/src/main/java/net/bull/javamelody/MonitoringFilter.java#L205\n\nSure, will do.",
      "parentUuid": "29647652_962cc716",
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "76d906e0_87177c78",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T08:09:45Z",
      "side": 1,
      "message": "\u003e \u003e Mention that basic auth doesn\u0027t work atm and that a bearer token auth is the only supported, known to work way for Prometheus scrapping of javameldoy metrics.\n\u003e \n\u003e Sure.\n\u003e \n\u003e \u003e That still raises the question, why basic auth doesn\u0027t actually work for javamelody integration, but (hopefully) works as claimed in metrics-reporter-prometheus plugin with basic auth, using?\n\u003e \u003e \n\u003e \u003e   GET http://gerrit.mycompany.com/a/plugins/metrics-reporter-prometheus/metrics\n\u003e \n\u003e The metrics-reporter for Prometheus is a Servlet and not a Filter. That\u0027s the reason why it can use Gerrit auth whilst the JavaMelody filter can\u0027t.\n\u003e \n\u003e At the end of the day, the JavaMelody filter needs to track *every request* even the ones failing for authentication denied.\n\u003e \n\u003e \u003e As discussed in another change that got abandoned, do you think, that patching Javamelody core (yes, I hate to patch third party libraries), like this would solve all our problems: [1]?\n\u003e \u003e \n\u003e \u003e Old:\n\u003e \u003e \n\u003e \u003e   if (httpRequest.getRequestURI().equals(getMonitoringUrl(httpRequest))) {\n\u003e \u003e   [...]\n\u003e \u003e \n\u003e \u003e New:\n\u003e \u003e \n\u003e \u003e   if (httpRequest.getRequestURI().endsWith(getMonitoringUrl(httpRequest))) {\n\u003e \u003e   [...]\n\u003e \n\u003e Nope, that would never work because we cannot condition the execution of the JavaMelody filter to the ProjectBasicAuth filter.\n\nThis is not Filter vs. Servlet issue, but has only to do with the order of filters declaration. This is a known issue, and Viktor Kaufman was trying to fix that in this change: [1]. I also provided a deep analysis in this comment: [2] fo why the authentication is working from the UI and not working from out side of the gerrit. Moreover I also provided a minimal invasive workaround to re-order the filter declarations and swpat the order between:\n\n* AllRequestFilter\n* GitOverHttpModule\n\nhere: [3].\n\nSo again, my assumption, that with these two patches:\n\n* Patch for Gerrit core: [3]\n* Patch to Javamelody core:\n\n  if (httpRequest.getRequestURI().endsWith(getMonitoringUrl(httpRequest)))\n  [...]\n\nBasic auth access from the Prometheus side would just work. Can you confirm that assumption, or do you want me to patch javamelody and upload that patch?\n\nOne reason, to try really hard to fix basic auth here, is because with this patch that took Prometheus-bearer-token route, the same Prometheus instance cannot use basic auth for another endpoint, that is exposed by the metrics-reporter-prometheus plugin:\n\n  GET http://gerrit.mycompany.com/a/plugins/metrics-reporter-prometheus/metrics\n\nright? But, there would a lot of value to be able to scrap both metrics from the *same* Prometheus side: Javamelody and the Gerrit core ones.\n\n@Sasha, Viktor: Even thouhg the review of that hange was staled, have we reached any consensus among the maintainers about swapping the order and fixing authentication in AllRequestFilter, when the request is coming not from the UI?\n\n@Luca, Please, add this above information to the commit message and explain why this plugin, that is currently based on the broken AllRequestFilter\u0027s authentication machinery cannot access user information, when the request is coming not from the UI, and also add a reference to Viktor\u0027s pending change that trying to fix that.\n\n[1] https://gerrit-review.googlesource.com/c/gerrit/+/164991\n[2] https://gerrit-review.googlesource.com/c/gerrit/+/164991/2//COMMIT_MSG#12\n[3] http://paste.openstack.org/show/705146",
      "parentUuid": "8433725b_11661ef3",
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e6a9d8ec_28e2df90",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "Please explicitly mention that no plugin own ViewMetrics capability checks take place on the user level in this scenario.",
      "range": {
        "startLine": 12,
        "startChar": 0,
        "endLine": 13,
        "endChar": 15
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ca27573f_3703f65d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-08-11T06:20:52Z",
      "side": 1,
      "message": "\u003e Please explicitly mention that no plugin own ViewMetrics capability checks take place on the user level in this scenario.\n\nSure, will do.",
      "parentUuid": "e6a9d8ec_28e2df90",
      "range": {
        "startLine": 12,
        "startChar": 0,
        "endLine": 13,
        "endChar": 15
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "10cd8ce7_4dbc3972",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/javamelody/GerritMonitoringFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 88,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "This should be named prometheusBearerToken as the constant name to exactly match the configuration option on the Prometheus side: [1].\n\n[1] https://prometheus.io/docs/prometheus/latest/configuration/configuration/",
      "range": {
        "startLine": 88,
        "startChar": 59,
        "endLine": 88,
        "endChar": 74
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "46e0bf28_81749ee0",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/javamelody/GerritMonitoringFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 88,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-08-11T06:20:52Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "10cd8ce7_4dbc3972",
      "range": {
        "startLine": 88,
        "startChar": 59,
        "endLine": 88,
        "endChar": 74
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d6dfcc39_e2af2dc2",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/javamelody/GerritMonitoringFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 184,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "Can\u0027t you use Javamelody exposed helper class, like this, see: [1]?\n\n  String format \u003d HttpParameter.FORMAT.getParameterFrom(httpRequest);\n\n[1] https://github.com/javamelody/javamelody/blob/master/javamelody-core/src/main/java/net/bull/javamelody/internal/web/MonitoringController.java#L219",
      "range": {
        "startLine": 184,
        "startChar": 15,
        "endLine": 184,
        "endChar": 78
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d2c518a4_ad830336",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/javamelody/GerritMonitoringFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 186,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "OK, we are skipping the internal ViewMetrics capability check on line 188. The reason for that is that the request doesn\u0027t send user to check against:\n\n  http://gerrit.mycompany.com/monitoring?format\u003dprometheus\n\nAnd we trust that if Gerrit Admin configured those javamelody plugin configuration option, then only she possess that token? (All what a attacker would need to do is to find out what the bearer token is and then she would be able to scrap the Javamelody metrics, but do we care?)",
      "range": {
        "startLine": 186,
        "startChar": 10,
        "endLine": 186,
        "endChar": 55
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "835a1c04_adc0c62c",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/javamelody/GerritMonitoringFilter.java",
        "patchSetId": 2
      },
      "lineNbr": 186,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-08-11T06:20:52Z",
      "side": 1,
      "message": "Good catch, will do.",
      "parentUuid": "d2c518a4_ad830336",
      "range": {
        "startLine": 186,
        "startChar": 10,
        "endLine": 186,
        "endChar": 55
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "941e2d2e_9be5c720",
        "filename": "src/main/resources/Documentation/config.md",
        "patchSetId": 2
      },
      "lineNbr": 29,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "Please explicitly mention that no plugin own ViewMetrics capability checks take place on the user level in this scenario.",
      "range": {
        "startLine": 28,
        "startChar": 2,
        "endLine": 29,
        "endChar": 22
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8865274c_0de70cca",
        "filename": "src/main/resources/Documentation/config.md",
        "patchSetId": 2
      },
      "lineNbr": 29,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-08-11T06:20:52Z",
      "side": 1,
      "message": "Ack, will do.",
      "parentUuid": "941e2d2e_9be5c720",
      "range": {
        "startLine": 28,
        "startChar": 2,
        "endLine": 29,
        "endChar": 22
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6dc548e8_33debdd5",
        "filename": "src/main/resources/Documentation/config.md",
        "patchSetId": 2
      },
      "lineNbr": 30,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-08-11T06:12:44Z",
      "side": 1,
      "message": "Can you also add a link where bearer_token or bearer_token_file configuration options are described on Prometheus side, e.g.:\n\n[1] https://prometheus.io/docs/prometheus/latest/configuration/configuration/",
      "range": {
        "startLine": 30,
        "startChar": 2,
        "endLine": 30,
        "endChar": 136
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bdaaff72_821df019",
        "filename": "src/main/resources/Documentation/config.md",
        "patchSetId": 2
      },
      "lineNbr": 30,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-08-11T06:20:52Z",
      "side": 1,
      "message": "Ack, will do.",
      "parentUuid": "6dc548e8_33debdd5",
      "range": {
        "startLine": 30,
        "startChar": 2,
        "endLine": 30,
        "endChar": 136
      },
      "revId": "2b90003581793f40ff571f3342e9d86c5b890a30",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}